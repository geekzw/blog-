---
title: TCP/UDP
date: 2016-12-02 14:46:38
categories:
tags:
---
## 运输层
TCP/UDP都是属于运输层，那么首先来了解一下运输层。我们知道，IP属于网络层，既然IP就实现了把数据从主机A传送到主机B。那为什么还需要运输层呢？这就不得不说一下IP和运输层的作用范围了。IP只负责把数据从A主机传送到B主机，这显然没有完成通信工作。我们平时上网时，发送和接收数据的完整流程是从我们上网用的联网程序（例如浏览器）到我们的PC再到目标主机，再到目标主机的服务器程序。然后同样的路径，目标主机的服务器会把我们请求的数据返回到我们的联网程序。从这个过程可以看出，IP能做的只是整个过程的中间一端，它并不能把数据直接送到PC上的应用程序，后面的工作，就是运输层要做的事情。我们说端到端通信，其实就是应用程序之间的通讯，也就是进程间通讯。运输层有个很重要的功能就是复用和分用，复用是指不同应用程序可以用同一个运输协议传送数据，分用是指，当一个应用程序跟多个远程应用通信的时候，运输层剥去报文首部后，能正确的把消息传给相应的程序
## 端口
前面提到，IP只负责把数据送到目的主机，运输层负责送到对应的应用程序，那么运输层怎么知道该送给哪个应用程序呢？这就是端口诞生的原因。有了端口号，我们甚至不用关心实现这个功能的是哪个进程，只需按端口号发送数据就行了。端口是一个16位的整数，共有65535个。其中有0~1023被系统端口占用，1024~49151是登记端口，使用这些端口必须登记，剩下的就是客户端使用的端口，又叫短暂端口，当一次链接断开后，端口就可以给其他客户端使用。
## TCP/UDP概述
TCP翻译为传输控制协议 面向连接。UDP翻译为用户数据报协议 面向无连接
![TCP/UDP体系][1]
## UDP
### 特点
* 面向无连接（发送前不需要建立连接，减少开销和发送数据之前的延时）
* 尽最大努力交付（但不保证交付）
* 面向报文（应用程序发过来的报文，UDP加上自己的头部，直接传给IP层，不做其他的修饰和分割。接收方接收后去掉UDP头部，就返给应用程序，由应用程序解析）
* 没有拥塞控制（允许有小部分数据丢失，但是不允许有较大的时延）
* 支持一对多，一对一，多对多的交互通信
* 首部开销少
通过上面的特点可以看出，UDP结构和实现还是比较简单的，最重要的就是他的首部格式了
* 源端口
* 目的端口
* 长度（UDP数据报的长度）
* 检验和
## TCP
### 特点
* 面向连接（传输数据前必须建立TCP连接，传输完成后必须关闭连接）
* 只允许点对点通信
* 提供可交付服务
* 全双工通信（发送端和接收端都设置了发送缓存和接收缓存，应用程序只需要把数据发送给发送缓存就行了，TCP会在合适的时候发送，同样，应用程序拿数据的时候，也只需要在接收缓存里拿）
* 面向字节流（TCP不关心发送方把数据分了几块，也不关心字节发送的顺序，它的任务是保证发送的总的字节流和接收的总的字节流相同，发送端可以根据数据长度，自由切割，接收方可以用任意个块接收）
### TCP连接
TCP是点到点连接，它的端点指的不是主机，不是IP地址也不是应用程序，而是套接字：ip：port
### 可靠的传输协议
#### 停止等待协议
通过名字就可以知道原理。当发送一组数据后就停止发送，等待接收端的相应，得到确认信息后再发送下一个分组。当出现错误时，就重新发送。发送分组时，都会设置一个定时器，设定超时时间，当超过超时时间没有得到回应后，就判断出错，重新发送。这里要注意几点
* 发送一个分组后，要保留分组的备份，以便失败重传
* 必须对发送分组和确认分组编号，以便知道发送或确认接收的是哪个分组
* 超时定时器时间应该比平均传输时间长一些，因为发送数据时并不知道走那些路由，也不知道网络状况，很有可能有延时
此协议对确认丢失的做法是重传，对确认迟到的做法是忽略。
很明显，此协议的最大缺点就是信道利用率很低
![此处输入图片的描述][2]
#### 连续ARQ协议（滑动窗口协议）
![此处输入图片的描述][3]
图a表示发送窗口，在发送窗口内的分组都可以连续发送出去，不需要等待前一个确认，这样就提高了信道利用率。发送方每收到一个确认，就把窗口向前滑动一个距离。接收方采用累积确认的方式，对按序到达的最后一个分组确认。当发送方接到确认后，就认为在这个序号之前的分组都已经确认到达了。这种方式优缺点很明显，优点是容易实现，缺点是中间有失败的分组发现不了


  [1]: http://ofy9dm2ii.bkt.clouddn.com/image/article/tcpudp1.png
  [2]: http://ofy9dm2ii.bkt.clouddn.com/image/article/tcpudp2.png
  [3]: http://ofy9dm2ii.bkt.clouddn.com/image/article/tcpudp3.png